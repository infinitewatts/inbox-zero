name: "Build Inbox Zero Docker Image"
run-name: "Build Inbox Zero Docker Image"

on:
  push:
    branches: ["main"]
    tags: ["v*"] # Also build on version tags for releases
  workflow_dispatch: # Allow manual trigger

permissions:
  contents: read
  packages: write
  id-token: write

env:
  DOCKER_IMAGE_REGISTRY: "ghcr.io"
  DOCKER_USERNAME: "elie222"
  DEPOT_PROJECT_ID: "2s1sh2pjrf"

jobs:
  preflight:
    if: github.repository == 'infinitewatts/inbox-zero'
    name: "Preflight (Lint + Typecheck)"
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up pnpm
        uses: pnpm/action-setup@v4
        with:
          run_install: false

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --no-frozen-lockfile --prefer-offline

      - name: Guardrails (strict on changed files)
        run: |
          set -euo pipefail
          BASE_SHA="${{ github.event.before }}"
          if [ -z "$BASE_SHA" ] || [ "$BASE_SHA" = "0000000000000000000000000000000000000000" ]; then
            BASE_SHA="$(git rev-parse HEAD~1 2>/dev/null || git rev-list --max-parents=0 HEAD)"
          fi
          if ! git rev-parse "$BASE_SHA" >/dev/null 2>&1; then
            BASE_SHA="$(git rev-list --max-parents=0 HEAD | tail -n1)"
          fi
          mapfile -t CHANGED_FILES < <(git diff --name-only "$BASE_SHA" "${{ github.sha }}" -- '*.ts' '*.tsx')
          if [ "${#CHANGED_FILES[@]}" -eq 0 ]; then
            echo "No TypeScript changes detected."
            exit 0
          fi
          printf 'Checking strict rules for:\n%s\n' "${CHANGED_FILES[@]}"
          pnpm exec biome check --config-path biome.strict.json "${CHANGED_FILES[@]}"

      - name: Typecheck
        run: pnpm -C apps/web exec tsc --noEmit -p tsconfig.ci.json

  build-docker:
    if: github.repository == 'elie222/inbox-zero'
    name: "Build Docker Image"
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate Docker tags
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            ghcr.io/${{ env.DOCKER_USERNAME }}/inbox-zero
            ${{ env.DOCKER_USERNAME }}/inbox-zero
          tags: |
            # Always tag with short SHA
            type=sha,prefix=
            # Tag 'latest' on main branch
            type=raw,value=latest,enable={{is_default_branch}}
            # Tag with version on v* tags (e.g., v2.26.0)
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.DOCKER_IMAGE_REGISTRY }}
          username: ${{ env.DOCKER_USERNAME }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Set up Depot
        uses: depot/setup-action@v1

      - name: Build and Push Docker Image
        uses: depot/build-push-action@v1
        with:
          project: ${{ env.DEPOT_PROJECT_ID }}
          context: .
          file: docker/Dockerfile.prod
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

      - name: Update Docker Hub Description
        uses: peter-evans/dockerhub-description@v4
        with:
          username: ${{ env.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
          repository: ${{ env.DOCKER_USERNAME }}/inbox-zero
          short-description: "Inbox Zero - AI email assistant for Gmail and Outlook to reach inbox zero fast"
          readme-filepath: ./README.md

  build-docker-fork:
    if: github.repository == 'infinitewatts/inbox-zero'
    name: "Build Docker Image (Fork)"
    runs-on: ubuntu-latest
    needs: preflight
    concurrency:
      group: build-docker-fork-${{ github.ref }}
      cancel-in-progress: true
    env:
      DOCKER_PLATFORMS: linux/amd64

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up QEMU
        if: contains(env.DOCKER_PLATFORMS, ',')
        uses: docker/setup-qemu-action@v3

      - name: Set up Buildx
        uses: docker/setup-buildx-action@v3

      - name: Generate Docker tags
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository_owner }}/inbox-zero
          tags: |
            type=sha,prefix=
            type=raw,value=latest,enable={{is_default_branch}}
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: docker/Dockerfile.prod
          platforms: ${{ env.DOCKER_PLATFORMS }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
