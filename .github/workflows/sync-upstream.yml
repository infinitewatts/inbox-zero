name: Sync with Upstream Inbox Zero

on:
  schedule:
    # Run every Sunday at midnight UTC
    - cron: '0 0 * * 0'
  workflow_dispatch:
    # Allow manual trigger

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"

      - name: Add upstream remote
        run: |
          git remote add upstream https://github.com/elie222/inbox-zero.git || true
          git fetch upstream

      - name: Get current branch
        id: branch
        run: echo "name=$(git rev-parse --abbrev-ref HEAD)" >> $GITHUB_OUTPUT

      - name: Attempt rebase
        id: rebase
        run: |
          git rebase upstream/main 2>&1 | tee rebase_output.txt
          if [ ${PIPESTATUS[0]} -ne 0 ]; then
            echo "conflict=true" >> $GITHUB_OUTPUT
            git rebase --abort
          else
            echo "conflict=false" >> $GITHUB_OUTPUT
          fi

      - name: Push changes
        if: steps.rebase.outputs.conflict == 'false'
        run: |
          git push --force-with-lease origin ${{ steps.branch.outputs.name }}
          echo "Successfully synced with upstream!"

      - name: Create issue on conflict
        if: steps.rebase.outputs.conflict == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const output = fs.readFileSync('rebase_output.txt', 'utf8');

            // Check for existing open issue
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'upstream-sync'
            });

            if (issues.data.length > 0) {
              // Update existing issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues.data[0].number,
                body: `## Sync attempted again\n\nConflict still exists. Output:\n\`\`\`\n${output}\n\`\`\``
              });
            } else {
              // Create new issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: '⚠️ Upstream sync conflict - manual intervention needed',
                labels: ['upstream-sync'],
                body: `## Upstream Sync Failed\n\nThe automated sync with \`elie222/inbox-zero\` encountered merge conflicts.\n\n### Rebase Output\n\`\`\`\n${output}\n\`\`\`\n\n### How to resolve\n\n1. Clone the repo locally\n2. Run:\n   \`\`\`bash\n   git fetch upstream\n   git rebase upstream/main\n   # Resolve conflicts\n   git push --force-with-lease\n   \`\`\`\n3. Close this issue\n\n### Files likely affected\n\nOur custom changes are in:\n- \`packages/email-tracking/\` (our package)\n- \`apps/web/utils/gmail/mail.ts\` (5 line change)\n- \`apps/web/package.json\` (1 line change)`
              });
            }

      - name: Summary
        run: |
          if [ "${{ steps.rebase.outputs.conflict }}" == "true" ]; then
            echo "::warning::Upstream sync failed due to conflicts. Check the created issue."
          else
            echo "::notice::Successfully synced with upstream!"
          fi
